cmake_minimum_required(VERSION 3.10)

project(libutils LANGUAGES CXX)

option(BDUIL_MAIN "编译.exe测试程序" ON)
option(BDUIL_GTEST "进行GTEST测试" OFF)

include("cmake/BuildModule.cmake")

# add all submodules
file(GLOB _MODULE_LIST LIST_DIRECTORIES TRUE "libs/*")
foreach(_SUB IN LISTS _MODULE_LIST)
	add_subdirectory(${_SUB})
endforeach()

add_library(
	libutils_all
	$<TARGET_OBJECTS:libutils::daemon>
	$<TARGET_OBJECTS:libutils::thread-slice>
	$<TARGET_OBJECTS:libutils::time>
	$<TARGET_OBJECTS:libutils::timer-task>
)
target_link_libraries(libutils_all PUBLIC libutils::template PUBLIC libutils::daemon libutils::thread-slice libutils::time libutils::timer-task)
add_library(${PROJECT_NAME}::libutils_all ALIAS libutils_all)

install(TARGETS libutils_all LIBRARY)

# build test
if(BDUIL_MAIN)
	find_package(GTest CONFIG REQUIRED)
	
	set(TEST_PROJECT ${PROJECT_NAME}-test)
	if(BDUIL_GTEST)
		add_executable(${TEST_PROJECT} "tests/TestThreadSlice.cpp" "tests/TestTimerTask.cpp")
		target_link_libraries(${TEST_PROJECT} PRIVATE GTest::gtest_main)
	else()
		add_executable(${TEST_PROJECT} "tests/main.cpp")
	endif()

	target_link_libraries(${TEST_PROJECT} PRIVATE libutils::libutils_all)
	target_compile_options(${TEST_PROJECT} PRIVATE "$<$<C_COMPILER_ID:MSVC>:/utf-8>" "$<$<CXX_COMPILER_ID:MSVC>:/utf-8>")
endif()

